---
title: "\U0001F554 Time Series"
author: Arvind Venkatadri
date: "`r Sys.Date()`"
tags:
  - CandleStick Graphs
  - Heatmap Graphs (over time)
  - Line Graphs
  - Time Series
subtitle: Time Series
weight: 80
summary: Trends, Seasons, and Changes over time
image:
  caption: Photo by rawpixel on Unsplash
  focal_point: Smart
slides: ""
url_code: ""
editor_options:
  markdown:
    wrap: 72
---

```{r setup, include=FALSE}

knitr::opts_chunk$set(echo = TRUE, fig.cap = c(5,4))
library(tidyverse)
library(magrittr)
library(lubridate)  # Deal with dates

library(mosaic)

library(tsibble)
library(tsibbledata)
library(fable)
library(fabletools)
library(feasts) # Feature Extraction and Statistics for Time Series.
library(timetk)  # Convert data frames to time series-specific objects
library(forecast)  # Make forecasts and decompose time series

# devtools::install_github("FinYang/tsdl")
library(tsdl) # Time Series Data Library from Rob Hyndman

library(downloadthis)

```


## Introduction

Any metric that is measured over regular time intervals forms a **time
series**. Analysis of Time Series is commercially important because of
industrial need and relevance, especially with respect to Forecasting
(Weather data, sports scores, population growth figures, stock prices,
demand, sales, supply...). In the graph shown below is the power consumption over times in two US cities:

<iframe width="100%" height="514" frameborder="0"
  src="https://observablehq.com/embed/f274bd3d517cf495?cells=LineChart"></iframe>
  

A time series can be broken down to its components so as to
systematically understand, analyze, model and forecast it. We have to
begin by answering fundamental questions such as:

1.  What are the types of time series?  
1.  How to decompose it? How to extract a level, a trend, and seasonal components from a time series?  
1.  What is auto correlation etc.  
1.  What is a stationary time series?  
1. And, how do you plot time series?  


## Time Series Data

Let us read and inspect in the US births data from 2000 to 2014. 

```{r Read_in_Data,echo=FALSE,message=FALSE}

births_2000_2014 <- read_csv("data/US_births_2000-2014_SSA.csv")

# # This data goes up to 2003, but the previous data starts at 2000, so we'll
# # remove 2000-2003 from here
# births_1994_1999 <- read_csv("data/US_births_1994-2003_CDC_NCHS.csv") %>% 
#   filter(year < 2000)
```


```{r}

mosaic::inspect(births_2000_2014)

```



So there are several numerical variables for `year`, `month`, and `day_of_month`, `day_of_week`, and of course the `births` on a daily basis. We will create a `date` column with these separate ones above, and then plot the births, say for the month of March, in each year:


```{r, echo=FALSE}

births_ts <- births_2000_2014 %>% 
  mutate(date = lubridate::make_date(year = year,
                                     month = month,
                                     day = date_of_month)) %>%
  
  # drop year month day since we have date
  select(date, births, date_of_month,day_of_week) %>% 
  tsibble::as_tsibble(index = date, # Time Variable
             key = births)

births_ts

births_ts %>%
  index_by(month = ~ yearmonth(.)) %>% # Grouping by month
  # Absolutely need this to take time averages
  summarise(mean_births = mean(births, na.rm = TRUE)) %>% 
# This creates a column called **month** 
# And another called **mean_births**

  timetk::plot_time_series(.date_var = month,
                           .value = mean_births,
                           .smooth = FALSE,
                           .title = "Births in the US over Time")
  

```



Hmm...can we try to plot box plots over time (Candle-Stick Plots)?



```{r, echo=FALSE,message=FALSE}

births_ts %>% 
  # No need to summarise, since we want boxplots per year / month
  plot_time_series_boxplot(.date_var = date, 
                                       .value = births,
                                       .period = "year",
                                       .title = "CandleStick Plot for US Births")


```





Are there trends over the years, or seasonal cycles in the births data?



```{r,echo=FALSE,message=FALSE}


births_ts %>% 
timetk::plot_stl_diagnostics(.date_var = date,
                             .value = births)

```



```{r, eval = FALSE}


births_decomposed <- 
  stl(births_ts$births, s.window = "periodic")

  fabletools::model(stl = STL())

fabletools::components(births_decomposed)

autoplot(components(births_decomposed))

```









How about a heatmap? We can cook up a categorical variable based on the number of births (low, fine, high) and use that to create a heatmap:


```{r,echo=FALSE}


library(ggformula)

births_2000_2014 %>%  
  mutate(birthrate = case_when(births >=10000 ~ "high", births <= 8000 ~ "low", TRUE ~ "fine")) %>% 
  gf_tile(data = ., year ~ month, fill = ~ birthrate, color = "black") %>%
  
  gf_theme(scale_x_time(breaks = 1:12, labels = c("Jan", "Feb", "Mar","Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"))) %>% 
  
  gf_theme(theme_classic())

```


## A Workflow in Orange

Download the Orange Workflow file by clicking the icon below, and open
it in Orange.

```{r, echo=FALSE, eval=FALSE}
download_file(
  path = "files/timeseries.ows",
  output_extension = ".ows",
  output_name = "orange-timeseries",
  button_label = "Download Orange Workflow",
  button_type = "danger",
  has_icon = TRUE,
  icon = "fa fa-save",
  self_contained = FALSE
)
```

## A Workflow in Radiant

Download the Radiant Workflow statefile by clicking the icon above, and
upload/open it in Radiant. You need to start radiant from the `Add-In`
menu in RStudio.

```{r, echo=FALSE,eval=FALSE}
download_file(
  path = "files/timeseries.rda",
  output_extension = ".rda",
  output_name = "radiant-timeseries",
  button_label = "Download Radiant Workflow",
  button_type = "danger",
  has_icon = TRUE,
  icon = "fa fa-save",
  self_contained = FALSE
)
```

## A Workflow in R

Download the RMarkdown tutorial file by clicking the icon above and open
it in RStudio or rstudio.cloud.

```{r, echo=FALSE}
download_file(
  path = "files/timeseries.Rmd",
  output_extension = ".Rmd",
  output_name = "r-timeseries",
  button_label = "Download RMArkdown Workflow",
  button_type = "danger",
  has_icon = TRUE,
  icon = "fa fa-save",
  self_contained = FALSE
)
```

## Readings

1. [The Nuclear Threat---The Shadow Peace, part
    1](http://www.fallen.io/shadow-peace/1/)
    
1.  [11 Ways to Visualize Changes Over Time -- A
    Guide](https://flowingdata.com/2010/01/07/11-ways-to-visualize-changes-over-time-a-guide/)


1.  [What is seasonal adjustment and why is it
    used?](http://junkcharts.typepad.com/junk_charts/2010/11/what-is-seasonal-adjustment-and-why-is-it-used.html)
    
1.  [The start-at-zero
    rule](http://junkcharts.typepad.com/junk_charts/2005/09/the_startatzero.html)
1.  [Keeping one's appetite after touring the sausage
    factory](http://junkcharts.typepad.com/numbersruleyourworld/2011/02/keeping-ones-appetite-after-touring-the-sausage-factory.html)
1.  [How Common is Your Birthday? This Visualization Might Surprise
    You](http://thedailyviz.com/2016/09/17/how-common-is-your-birthday-dailyviz/)

1.  [The Fallen of World War II](http://www.fallen.io/ww2/)
2.  [Visualizing Statistical Mix Effects and Simpson's
    Paradox](https://static.googleusercontent.com/media/research.google.com/en//pubs/archive/42901.pdf)
3.  [How To Fix a Toilet (And Other Things We Couldn't Do Without
    Search)](http://how-to-fix-a-toilet.com/)


------------------------------------------------------------------------
