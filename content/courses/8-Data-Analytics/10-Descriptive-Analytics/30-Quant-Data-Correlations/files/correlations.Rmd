---
title: "Correlations in R"
author: "Arvind Venkatadri"
date: "`r Sys.Date()`"
output:
  html_document:
    theme: flatly
    toc: TRUE
    toc_float: TRUE
    toc_depth: 2
    df_print: paged
    number_sections: TRUE
    code_folding: show
    code_download: TRUE

---

# Introduction

We will craate Tables for Correlations, and graphs for Correlations in R. As always, we will consistently use the [**Project Mosaic**](https://mosaic-web.org) ecosystem of packages in R (`mosaic`, `mosaicData` and `ggformula`). 

```{r, echo = FALSE, message = FALSE, include=TRUE}
knitr::opts_chunk$set(collapse = T, comment = "#>", echo = TRUE)
options(tibble.print_min = 4L, tibble.print_max = 4L)
library(mosaic) # package for stats, simulations, and basic plots
library(mosaicData) # package containing datasets
library(ggformula) # package for professional looking plots, that use the formula interface from mosaic
library(NHANES) # survey data collected by the US National Center for Health Statistics (NCHS)
library(corrplot) # For Correlogram plots

```


::: {#note .illustration style="background: beige"}
Note the standard method for all commands from the `mosaic` package:

goal( y \~ x \| z, data = mydata, ...)
:::


## Case Study -1: Dataset from `mosaicData`

Let us inspect what datasets are available in the package `mosaicData`. Run this command in your Console:

```{r, eval=FALSE}
# Run in Console
data(package = "mosaicData")

```

The popup tab shows a lot of datasets we could use. Let us continue to use the famous `Galton` dataset and `inspect` it:

```{r}
data("Galton")
inspect(Galton)

```
The `inspect` command already gives us a series of statistical measures of different variables of interest. As discussed previously, we can retain the output of `inspect` and use it in our reports: (there are ways of dressing up these tables too)

```{r Galton-inspect}

galton_describe <- inspect(Galton)

galton_describe$categorical
galton_describe$quantitative

```



Try `help("Galton")` in your Console. The dataset is described as:

> A data frame with 898 observations on the following variables.  
- `family` a factor with levels for each family  
- `father` the father's height (in inches)  
- `mother` the mother's height (in inches)  
- `sex` the child's sex: F or M  
- `height` the child's height as an adult (in inches)  
- `nkids` the number of adult children in the family, or, at least, the number whose heights Galton recorded.  

There is a lot of Description generated by the `mosaic::inspect()` command ! 
What can we say about the dataset and its variables? How big is the dataset? How many variables? What types are they, Quant or Qual? If they are Qual, what are the *levels*? Are they *ordered* levels? Discuss!


## Correlations and Plots

What Questions might we have, that we could answer with a Statistical Measure, or Correlation chart?

Q.1 Which are the variables that have significant pair-wise correlations? What polarity are these correlations?

```{r,message=FALSE}


# Pulling out the list of Quant variables from NHANES
galton_quant <- galton_describe$quantitative
galton_quant$name

GGally::ggpairs(
  Galton,
  columns = c("father", "mother", "height", "nkids"),
  diag = list("densityDiag"),
  title = "Galton Data Correlations Plot"
)

```
Can we plot a Correlogram for this dataset?

```{r}
#library(corrplot)

galton_num_var <- Galton %>% select(father, mother, height, nkids)
galton_cor <- cor(galton_num_var)
galton_correlogram <- galton_cor %>%
  corrplot(method = "ellipse",
           type = "lower",
           main = "Correlogram for Galton dataset")
galton_correlogram

```

Clearly `height` is positvely correlated to `father` and `mother`; interestingly, `height` is negatively correlated ( slightly) with `nkids`. 

Q.2: Let us confirm with a test:

```{r}
mosaic::cor_test(height ~ father, data = Galton)
```

```{r}
mosaic::cor_test(height ~ mother, data = Galton)
```
Q.3 What does this correlation look when split by `sex` of Child?
```{r}

# For the sons
cor_test(height ~ father, data = Galton %>% filter(sex == "M"))
cor_test(height ~ mother, data = Galton %>% filter(sex == "M"))

# For the daughters
cor_test(height ~ father, data = Galton %>% filter(sex == "F"))
cor_test(height ~ mother, data = Galton %>% filter(sex == "F"))
         
```

Q.4. How can we show this correlation in a set of Scatter Plots + Regression Lines? Can we recreate Galton's famous diagram?

```{r}
# For the sons
gf_point(height ~ father, data = Galton %>% filter(sex == "M")) %>% gf_smooth(method = "lm")
gf_point(height ~ mother, data = Galton %>% filter(sex == "M")) %>% gf_smooth(method = "lm")

# For the daughters
gf_point(height ~ father, data = Galton %>% filter(sex == "F")) %>% gf_smooth(method = "lm")
gf_point(height ~ mother, data = Galton %>% filter(sex == "F")) %>% gf_smooth(method = "lm")
```
An approximation to Galton's famous plot (see Wikipedia):
```{r}
gf_point(height ~ (father + mother)/2, data = Galton) %>% gf_smooth(method = "lm") %>% gf_density_2d(n = 8) %>% gf_abline(slope = 1)
```
How would you interpret this plot?

## Case Study -2: Dataset from `NHANES`
We will "live code" this in class!




# Conclusion
We have a decent Correlations related *workflow* in R:  
- load the dataset  
- `inspect` the dataset, identify Quant and Qual variables  
- Develop Pair-Wise plots + Correlations using `GGally::ggpairs()`  
- Develop Correlogram `corrplot::corrplot`  
- Check everything with a `cor_test`  
- Plot scatter plots using `gf_point` if needed.   
- Add extra lines using `gf_abline()` to compare hypotheses that you may have.




