---
title: "Permutation Tests"
author: "Arvind Venkatadri
date: "`r Sys.Date()`"
output:
  html_document:
    theme: flatly
    toc: TRUE
    toc_float: TRUE
    toc_depth: 2
    df_print: paged
    number_sections: TRUE
    code_folding: hide
    code_download: TRUE
editor_options: 
  markdown: 
    wrap: 72
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, out.width="50%")
library(ggplot2)
library(dplyr)
library(mosaic)
```

## Permutation Tests

### Case Study-1: Hot Wings vs Gender
```{r}
Beerwings <- read.csv("https://sites.google.com/site/chiharahesterberg/data2/Beerwings.csv")
inspect(Beerwings)
```



 Let us calculate the observed difference in `Hotwings` consumption between Males and Females ( `Gender`)
 
```{r}
mean(Hotwings ~ Gender, data = Beerwings)
obs_diff_wings <- mosaic::diffmean(data = Beerwings, Hotwings ~ Gender)
observed_diff
```


```{r}
null_dist_wings <- do(1000) * diffmean(Hotwings ~ shuffle(Gender), data = Beerwings)
null_dist_wings %>% head()

gf_histogram(data = null_dist_wings, ~ diffmean) %>% 
  gf_vline(xintercept = obs_diff_wings, colour = "red")

prop1(~ diffmean >= obs_diff_wings, data = null_dist_wings)

```


### Case Study-2: Verizon

```{r}
verizon <- read.csv("https://sites.google.com/site/chiharahesterberg/data2/Verizon.csv")
inspect(verizon)

```
```{r}
mean(Time ~ Group, data = verizon)
obs_diff_verizon <- diffmean(Time ~ Group, data = verizon)
obs_diff_verizon
```


```{r}
null_dist_verizon <- do(1000) * diffmean(Time ~ shuffle(Group), data = verizon)
gf_histogram(data = null_dist_verizon, ~ diffmean) %>% 
  gf_vline(xintercept = obs_diff_wings, colour = "red")

prop1(~ diffmean >= obs_diff_wings, data = null_dist_verizon)

```





### Case Story-3: Recidivism
Do criminals released after a jail term commit crimes again?

```{r}
recidivism <- read.csv("http://sites.google.com/site/chiharahesterberg/data2/Recidivism.csv")
inspect(recidivism)
```
There are some missing values in the variable <tt> `Age25`</tt>. The <tt> `complete.cases`</tt> command gives the row numbers where values are not missing. We create a new data frame omitting the rows where there is a missing value in the <tt> 'Age25' </tt> variable.

```{r}
recidivism_na <- recidivism %>% tidyr::drop_na(Age25)

```

Also, the variable <tt>`Recid`</tt> is a factor variable coded "Yes" or "No". We convert it to a numeric variable of 1's and 0's. 
 
```{r}
recidivism_na <- recidivism_na %>% mutate(Recid2 = ifelse(Recid=="Yes", 1, 0))

obs_diff_recid <- diffmean( Recid2 ~ Age25, data = recidivism_na)
obs_diff_recid

null_dist_recid <- do(1000) * diffmean( Recid2 ~ shuffle(Age25), data = recidivism_na)

gf_histogram( ~ diffmean, data = null_dist_recid) %>% 
  gf_vline(xintercept = obs_diff_recid, colour = "red")
```


### Case Study-4: Matched Pairs: Results from a diving championship.

```{r}
Diving2017 <- read.csv("http://sites.google.com/site/chiharahesterberg/data2/Diving2017.csv")
inspect(Diving2017)
```
The data is made up of **paired** observations per swimmer. So we need to take the difference between the two swim records for *each* swimmer and then shuffle the differences to either polarity. 
Another way to look at this is to shuffle the records between `Semifinal` and `Final` on a per Swimmer basis. 

```{r}
Diving2017
Diving2017 %>% diffmean(data= ., Final ~ Semifinal, only.2 = FALSE)
obs_diff_swim <- mean(Diff, data = Diving2017)

```




```{r}
polarity <- c(rep(1, 6), rep(-1,6))
polarity
null_dist_swim <- do(100000) * mean(data = Diving2017, 
                                    Diff * resample(polarity,
                                                    replace = TRUE))
null_dist_swim %>% head()
gf_histogram(data = null_dist_swim, ~mean) %>% 
  gf_vline(xintercept = obs_diff_swim, colour = "red")
```

### Case Study 5: Proportions between Categorical Variables

